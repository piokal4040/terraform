trigger:
- main

# IMPORTANT: You do NOT have Microsoft-hosted agents enabled.
# Replace with your self-hosted agent pool name.
pool:
  name: Default     # ‚Üê change ONLY if your agent pool has a different name

steps:
- task: TerraformInstaller@1
  displayName: 'Install Terraform'
  inputs:
    terraformVersion: 'latest'

# Terraform Init
- task: TerraformTaskV4@4
  displayName: 'Terraform Init'
  inputs:
    provider: azurerm
    command: init
    backendServiceArm: azure-service-connection          # Required for backend
    backendAzureRmResourceGroupName: my-tfstate-rg
    backendAzureRmStorageAccountName: mytfstateacc
    backendAzureRmContainerName: tfstate
    backendAzureRmKey: terraform.tfstate
    environmentServiceNameAzureRM: azure-service-connection
    azureServicePrincipalClientId: 'b5607e7e-7e92-4d23-9cfb-82dbaff439e6'
    azureServicePrincipalKey: '5cY8Q~agwdCzGIgd6eioVeW6FLH6z5StHMlpLcl'
    azureTenantId: 'c5acaccb-b545-4150-bb66-2d947b28bbd1'

# Terraform Plan
- task: TerraformTaskV4@4
  displayName: 'Terraform Plan'
  inputs:
    provider: azurerm
    command: plan
    environmentServiceNameAzureRM: azure-service-connection
    azureServicePrincipalClientId: 'b5607e7e-7e92-4d23-9cfb-82dbaff439e6'
    azureServicePrincipalKey: '5cY8Q~agwdCzGIgd6eioVeW6FLH6z5StHMlpLcl'
    azureTenantId: 'c5acaccb-b545-4150-bb66-2d947b28bbd1'

# Terraform Apply
- task: TerraformTaskV4@4
  displayName: 'Terraform Apply'
  inputs:
    provider: azurerm
    command: apply
    environmentServiceNameAzureRM: azure-service-connection
    azureServicePrincipalClientId: 'b5607e7e-7e92-4d23-9cfb-82dbaff439e6'
    azureServicePrincipalKey: '5cY8Q~agwdCzGIgd6eioVeW6FLH6z5StHMlpLcl'
    azureTenantId: 'c5acaccb-b545-4150-bb66-2d947b28bbd1'
